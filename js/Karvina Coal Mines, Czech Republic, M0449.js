
    var mine = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [
              18.570978,
              49.813669
            ],
            [
              18.567157,
              49.813699
            ],
            [
              18.572886,
              49.820118
            ],
            [
              18.530548,
              49.832849
            ],
            [
              18.530366,
              49.822136
            ],
            [
              18.522727,
              49.823318
            ],
            [
              18.506383,
              49.819016
            ],
            [
              18.470832,
              49.819575
            ],
            [
              18.471314,
              49.818171
            ],
            [
              18.469041,
              49.809293
            ],
            [
              18.467985,
              49.809442
            ],
            [
              18.467925,
              49.803797
            ],
            [
              18.492992,
              49.80271
            ],
            [
              18.498544,
              49.80884
            ],
            [
              18.528165,
              49.805529
            ],
            [
              18.528161,
              49.805514
            ],
            [
              18.531154,
              49.77632
            ],
            [
              18.584368,
              49.775036
            ],
            [
              18.590333,
              49.777987
            ],
            [
              18.587384,
              49.79129
            ],
            [
              18.580172,
              49.795384
            ],
            [
              18.580558,
              49.805424
            ],
            [
              18.570978,
              49.813669
            ]
          ]
        ]
      },
      "properties": {
        "id": "M0449.B2",
        "mine feature category": "mine boundary",
        "mine feature subcategory": "underground",
        "data source date": "2025-06-17 00:00:00",
        "notes": "The boundaries of mines in the Karvina coal basin were identified in Figure 1 in Holub, Karel & Ru\u0161ajov\u00e1, Jana. (2015). Regularity of particle velocity decrease with scaled distance for rockbursts and shot holes. Acta Montanistica Slovaca. 20. 80-85. 10.3390/ams20020080, September 2015 on the Ostrava-Karvin\u00e1 Coal Basin (https://web.archive.org/save/https://www.researchgate.net/figure/The-map-of-boundaries-of-coal-basins-and-demarcations-of-mines-in-the-OKCB-1_fig1_283801856). The diagram was overlayed in Google Earth Pro satellite imagery and boundary polygons were extracted. As many of the individual mines in the Karvina cluster were merged or closed since their original designations, the polygons of the relevant boundaries for only the active \u010cSM mines were derived from the individual mine boundaries, excluding the following mines, which are considered separate and now closed (i.e., no longer in operation): Lazy coal mine, \u010cSA coal mine, 9 Kveten coal mine, and extensions to the former Darkov coal mine. The area of this mine boundary polygon is approximately 28 sq km.",
        "description": "Karvina coal mines (active) boundary",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.556092,
          49.804342
        ]
      },
      "properties": {
        "id": "M0449.P1",
        "mine feature category": "ventilation system",
        "mine feature subcategory": "vent",
        "data source date": "2025-06-17 00:00:00",
        "notes": "The two ventilation shafts at the \u010cSM mine were identified via visual analysis of Google Earth Pro satellite imagery.",
        "description": "Ventilation shafts (\u010cSM South)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.555433,
          49.802744
        ]
      },
      "properties": {
        "id": "M0449.P2",
        "mine feature category": "other",
        "mine feature subcategory": "mine entrance or exit",
        "data source date": "2025-06-17 00:00:00",
        "notes": "This possible mine entrance or access shaft to the \u010cSM mine was identified using Google Maps public data and photographic imagery (https://web.archive.org/save/https://www.google.com/maps/place/D%C5%AFl+%C4%8CSM+-+jih/@49.8030558,18.5555584,236m/data=!3m1!1e3!4m6!3m5!1s0x4714019b2af7822b:0xa62afa4a17e4da2d!8m2!3d49.803235!4d18.5552181!16s%2Fg%2F11q2rz4djk?entry=ttu&g_ep=EgoyMDI1MDgwNC4wIKXMDSoASAFQAw%3D%3D), and confirmed with visual analysis of Google Earth Pro satellite imagery.",
        "description": "Possible mine entrance or shaft (\u010cSM South)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.557577,
          49.808101
        ]
      },
      "properties": {
        "id": "M0449.P3",
        "mine feature category": "ventilation system",
        "mine feature subcategory": "vent",
        "data source date": "2025-06-17 00:00:00",
        "notes": "These possible vents within the boundaries of the \u010cSM mine were identified via visual analysis of Google Earth Pro satellite imagery.",
        "description": "Possible vents (\u010cSM South)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.550318,
          49.818693
        ]
      },
      "properties": {
        "id": "M0449.P4",
        "mine feature category": "other",
        "mine feature subcategory": "preparation plant",
        "data source date": "2025-06-17 00:00:00",
        "notes": "This coal handling and preparation plant (CHPP) was identified via OKD's virtual 3D map of the \u010cSM North coal mine facility (https://web.archive.org/save/https://www.okd.cz/virtual-tour/index.html). The asset's exact location and coordinates were then visually confirmed and extracted in Google Earth Pro.",
        "description": "Coal handling and preparation plant (\u010cSM North)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.549453,
          49.815828
        ]
      },
      "properties": {
        "id": "M0449.P5",
        "mine feature category": "degasification system",
        "mine feature subcategory": "drainage station",
        "data source date": "2025-06-17 00:00:00",
        "notes": "This degassification station was identified via OKD's virtual 3D map of the \u010cSM North coal mine facility (https://web.archive.org/save/https://www.okd.cz/virtual-tour/index.html). The asset's exact location and coordinates were then visually confirmed and extracted in Google Earth Pro.",
        "description": "Degassing station (\u010cSM North)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.548801,
          49.81716
        ]
      },
      "properties": {
        "id": "M0449.P6",
        "mine feature category": "other",
        "mine feature subcategory": "mine entrance or exit",
        "data source date": "2025-06-17 00:00:00",
        "notes": "This mine entrance was identified via OKD's virtual 3D map of the \u010cSM North coal mine facility (https://web.archive.org/save/https://www.okd.cz/virtual-tour/index.html). The asset's exact location and coordinates were then visually confirmed and extracted in Google Earth Pro.",
        "description": "Mine entrance (\u010cSM North)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          18.549483,
          49.817035
        ]
      },
      "properties": {
        "id": "M0449.P7",
        "mine feature category": "degasification system",
        "mine feature subcategory": "combined heat and power plant",
        "data source date": "2025-06-17 00:00:00",
        "notes": "This combined heat and power station was first identified via OKD's virtual 3D map of the \u010cSM North coal mine facility as a heat plant (https://web.archive.org/save/https://www.okd.cz/virtual-tour/index.html). The CHP unit was confirmed to produce both heat and electricity in a 2022 OKD report (https://web.archive.org/save/https://portal.cenia.cz/eiasea/download/RUlBX01aUDUxNl9vem5hbWVuaURPQ18yMzU2MjU0ODQ3MDc1OTg0Mzc5LnBkZg/MZP516_oznameni.pdf) The asset's exact location and coordinates were then visually confirmed and extracted in Google Earth Pro.",
        "description": "Combined heat and power plant (\u010cSM North)",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M0449",
        "Owners": "OKD AS [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "PRISKO AS",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Karvina_coal_mines",
        "GEM Wiki Page (Non-ENG)": "",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Karvina Coal Mines",
        "Country / Area": "Czech Republic",
        "Last researched": "Aug 08, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    }
  ]
}
    var bounds = L.latLngBounds(L.latLng(49.775036, 18.467925), L.latLng(49.832849, 18.590333));                        
    var googleStreet =  L.tileLayer('https://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}', {maxZoom: 20, attribution: '&copy; Google Maps'})
    var googleHybrid =  L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', {maxZoom: 20, attribution: '&copy; Google Maps'})
    
    // When this map is embedded in the GEM Wiki via an iframe widget, the enclosing html css for width and height of #map does not consistently
    // come through, resulting in sometimes being 0, 0. This seems to mess fitBounds up resulting in a fully zoomed out map showing the entire planet.
    // I tried many different adjustments, but in the end chose a setView with a fixed zoom of 12 to be much more reliable.
    //var map = L.map('map', {layers: [googleHybrid]}).fitBounds(bounds) 
                        
    var map = L.map('map', {layers: [googleHybrid]}).setView([49.803942500000005, 18.529129], 12.0)                     
    var markerLayerGroup = L.layerGroup();
                        

    function onEachFeature(feature, layer) {
        let popupContent = "<b><u>" + feature.properties['description'] + "</u></b><br /><br />"
        let tooltipContent = feature.properties['id'] + ": " + feature.properties['description']
        for (const [key, value] of Object.entries(feature.properties)) {
            popupContent += '<b>' + key + '</b>: ' + value + '<br />'
        }
        layer.bindPopup(popupContent, { maxHeight: 200 , maxWidth: 400})
        layer.bindTooltip(tooltipContent, { permanent: false, direction: 'right'});
        if (feature.properties['mine feature category'] == "mine boundary") {
           layer.setStyle({ color: '#CA4A50', fillColor: '#CA4A50', opacity: 1.0 });
        }
        markerLayerGroup.addLayer(layer)
	}
    
    markerLayerGroup.addTo(map);
    const mineLayer = L.geoJSON(mine, {onEachFeature}).addTo(map)
    var GEMMineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/kml/paddle/red-circle.png', iconSize:  [40, 40]});
    
    const myDiv = document.getElementById('map');
    const width = myDiv.offsetWidth;
    const height = myDiv.offsetHeight;
    console.log("#map width: " + width + ", height: " + height);                    

    // Create a "dummy" layer group specifically to act as the tooltip toggle switch in the control
    var tooltipToggleLayer = L.layerGroup();
    // Add event listeners to the map that listen for the toggle layer being added or removed
    map.on('layeradd', function (e) {
        if (e.layer === tooltipToggleLayer) {
            // When the "Tooltip" overlay is selected, iterate over all markers and make tooltips permanent
            markerLayerGroup.eachLayer(function (layer) {
                if (layer.getTooltip()) {
                    layer.getTooltip().options.permanent = true;
                    layer.openTooltip(); // Open the tooltip permanently
                }
            });
        }
    });
    map.on('layerremove', function (e) {
        if (e.layer === tooltipToggleLayer) {
            // When the "Tooltip" overlay is deselected, make tooltips non-permanent and close them
            markerLayerGroup.eachLayer(function (layer) {
                if (layer.getTooltip()) {
                    layer.getTooltip().options.permanent = false;
                    layer.closeTooltip();
                }
            });
        }
    });

    map.on('zoomend', function() {
        console.log("Current zoom level: " + map.getZoom());
    });

    var baseMaps = {
        "Satellite view": googleHybrid,
        "Street view": googleStreet
    };
    var overlayMaps = {
        "Labels": tooltipToggleLayer // The toggle switch for tooltips
    };
    var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
                        
    var GEMMine;
                        
    GEMMine = L.marker([49.81706578, 18.54849501], {icon: GEMMineIcon}).addTo(map); 
    GEMMine.bindPopup('Operating status(es): Operating');
    GEMMine.bindTooltip('Karvina Coal Mines', { permanent: true, direction: 'right'});
