
    var mine = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [
              106.820448,
              37.684834
            ],
            [
              106.832115,
              37.687334
            ],
            [
              106.866407,
              37.696481
            ],
            [
              106.866275,
              37.701744
            ],
            [
              106.866531,
              37.706382
            ],
            [
              106.86574,
              37.711051
            ],
            [
              106.865445,
              37.714228
            ],
            [
              106.867315,
              37.720873
            ],
            [
              106.868185,
              37.724126
            ],
            [
              106.868017,
              37.728078
            ],
            [
              106.866298,
              37.734801
            ],
            [
              106.866405,
              37.739711
            ],
            [
              106.866313,
              37.743019
            ],
            [
              106.865835,
              37.746542
            ],
            [
              106.866015,
              37.749748
            ],
            [
              106.865312,
              37.753265
            ],
            [
              106.863888,
              37.755793
            ],
            [
              106.863968,
              37.758062
            ],
            [
              106.860671,
              37.767666
            ],
            [
              106.858899,
              37.770811
            ],
            [
              106.856487,
              37.774468
            ],
            [
              106.853461,
              37.777756
            ],
            [
              106.853471,
              37.781747
            ],
            [
              106.851963,
              37.786221
            ],
            [
              106.849522,
              37.791481
            ],
            [
              106.845047,
              37.794643
            ],
            [
              106.839276,
              37.80343
            ],
            [
              106.833651,
              37.816012
            ],
            [
              106.822117,
              37.821779
            ],
            [
              106.784616,
              37.800946
            ],
            [
              106.786283,
              37.799279
            ],
            [
              106.787672,
              37.795946
            ],
            [
              106.78795,
              37.791779
            ],
            [
              106.788228,
              37.790112
            ],
            [
              106.790727,
              37.783724
            ],
            [
              106.793783,
              37.780112
            ],
            [
              106.794894,
              37.77789
            ],
            [
              106.795449,
              37.776501
            ],
            [
              106.797394,
              37.775668
            ],
            [
              106.799894,
              37.775112
            ],
            [
              106.801283,
              37.773446
            ],
            [
              106.801561,
              37.770946
            ],
            [
              106.803227,
              37.767612
            ],
            [
              106.803227,
              37.762334
            ],
            [
              106.803783,
              37.758445
            ],
            [
              106.804616,
              37.75539
            ],
            [
              106.805171,
              37.75289
            ],
            [
              106.805727,
              37.749834
            ],
            [
              106.80656,
              37.747612
            ],
            [
              106.808782,
              37.745945
            ],
            [
              106.81406,
              37.739834
            ],
            [
              106.816005,
              37.735112
            ],
            [
              106.816838,
              37.730112
            ],
            [
              106.817115,
              37.724556
            ],
            [
              106.815727,
              37.720112
            ],
            [
              106.815726,
              37.71789
            ],
            [
              106.817393,
              37.710667
            ],
            [
              106.817948,
              37.705112
            ],
            [
              106.819059,
              37.701223
            ],
            [
              106.819337,
              37.694834
            ],
            [
              106.820448,
              37.684834
            ]
          ]
        ]
      },
      "properties": {
        "id": "M1200.B1",
        "mine feature category": "mine boundary",
        "mine feature subcategory": "underground",
        "data source date": "2019-10-15 00:00:00",
        "notes": "The boundary coordinates are found in the mining coordinates table on page 9 in the document State Energy Group Ningxia Coal Industry Co., Ltd. Shuangma No. 1 Coal Mine Mining Rights Income Evaluation Report (\u56fd\u5bb6\u80fd\u6e90\u96c6\u56e2\u5b81\u590f\u7164\u4e1a\u6709\u9650\u8d23\u4efb\u516c\u53f8\u53cc\u9a6c\u4e00\u7164\u77ff\u91c7\u77ff\u6743\u51fa\u8ba9\u6536\u76ca\u8bc4\u4f30\u62a5\u544a), https://web.archive.org/web/20250806224445/http://wenku.edumine.net/doc/169890.html.",
        "description": "Shuangma coal mine boundary",
        "coordinates precision": "reported",
        "GEM Mine ID": "M1200",
        "Owners": "China ENERGY Group Ningxia Coal Industry Company [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "China Energy [51%]; Ningxia State-Owned Asset Operation Group [49%]",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Shuangma_No.1_Coal_Mine",
        "GEM Wiki Page (Non-ENG)": "https://www.gem.wiki/%E7%A5%9E%E5%8D%8E%E5%AE%81%E5%A4%8F%E7%85%A4%E4%B8%9A%E9%9B%86%E5%9B%A2%E5%8F%8C%E9%A9%AC%E4%B8%80%E7%9F%BF",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Shuangma No.1 Coal Mine",
        "Country / Area": "China",
        "Last researched": "Aug 06, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          106.820823,
          37.773034
        ]
      },
      "properties": {
        "id": "M1200.P1",
        "mine feature category": "ventilation system",
        "mine feature subcategory": "shaft",
        "data source date": "2024-10-01 00:00:00",
        "notes": "Identified visually from Google Earth Pro satellite imagery.",
        "description": "Ventilation shaft",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M1200",
        "Owners": "China ENERGY Group Ningxia Coal Industry Company [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "China Energy [51%]; Ningxia State-Owned Asset Operation Group [49%]",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Shuangma_No.1_Coal_Mine",
        "GEM Wiki Page (Non-ENG)": "https://www.gem.wiki/%E7%A5%9E%E5%8D%8E%E5%AE%81%E5%A4%8F%E7%85%A4%E4%B8%9A%E9%9B%86%E5%9B%A2%E5%8F%8C%E9%A9%AC%E4%B8%80%E7%9F%BF",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Shuangma No.1 Coal Mine",
        "Country / Area": "China",
        "Last researched": "Aug 06, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          106.821226,
          37.773595
        ]
      },
      "properties": {
        "id": "M1200.P2",
        "mine feature category": "ventilation system",
        "mine feature subcategory": "shaft",
        "data source date": "2024-10-01 00:00:00",
        "notes": "Identified visually from Google Earth Pro satellite imagery.",
        "description": "Ventilation shaft",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M1200",
        "Owners": "China ENERGY Group Ningxia Coal Industry Company [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "China Energy [51%]; Ningxia State-Owned Asset Operation Group [49%]",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Shuangma_No.1_Coal_Mine",
        "GEM Wiki Page (Non-ENG)": "https://www.gem.wiki/%E7%A5%9E%E5%8D%8E%E5%AE%81%E5%A4%8F%E7%85%A4%E4%B8%9A%E9%9B%86%E5%9B%A2%E5%8F%8C%E9%A9%AC%E4%B8%80%E7%9F%BF",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Shuangma No.1 Coal Mine",
        "Country / Area": "China",
        "Last researched": "Aug 06, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          106.845235,
          37.782262
        ]
      },
      "properties": {
        "id": "M1200.P3",
        "mine feature category": "other",
        "mine feature subcategory": "slope access or production shaft",
        "data source date": "2024-10-01 00:00:00",
        "notes": "Identified visually from Google Earth Pro satellite imagery.",
        "description": "Auxiliary Slope",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M1200",
        "Owners": "China ENERGY Group Ningxia Coal Industry Company [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "China Energy [51%]; Ningxia State-Owned Asset Operation Group [49%]",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Shuangma_No.1_Coal_Mine",
        "GEM Wiki Page (Non-ENG)": "https://www.gem.wiki/%E7%A5%9E%E5%8D%8E%E5%AE%81%E5%A4%8F%E7%85%A4%E4%B8%9A%E9%9B%86%E5%9B%A2%E5%8F%8C%E9%A9%AC%E4%B8%80%E7%9F%BF",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Shuangma No.1 Coal Mine",
        "Country / Area": "China",
        "Last researched": "Aug 06, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    },
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          106.848873,
          37.784149
        ]
      },
      "properties": {
        "id": "M1200.P4",
        "mine feature category": "other",
        "mine feature subcategory": "slope access or production shaft",
        "data source date": "2024-10-01 00:00:00",
        "notes": "Identified visually from Google Earth Pro satellite imagery.",
        "description": "Main Slope",
        "coordinates precision": "extracted",
        "GEM Mine ID": "M1200",
        "Owners": "China ENERGY Group Ningxia Coal Industry Company [100%]",
        "Owners (Non-ENG)": "",
        "Parent Company": "China Energy [51%]; Ningxia State-Owned Asset Operation Group [49%]",
        "GEM Wiki Page (ENG)": "https://www.gem.wiki/Shuangma_No.1_Coal_Mine",
        "GEM Wiki Page (Non-ENG)": "https://www.gem.wiki/%E7%A5%9E%E5%8D%8E%E5%AE%81%E5%A4%8F%E7%85%A4%E4%B8%9A%E9%9B%86%E5%9B%A2%E5%8F%8C%E9%A9%AC%E4%B8%80%E7%9F%BF",
        "Coal Grade": "Thermal & Met",
        "Mine Name": "Shuangma No.1 Coal Mine",
        "Country / Area": "China",
        "Last researched": "Aug 06, 2025",
        "build_version": "Coal Mine Boundaries and Methane Sources - version 1.0.1 (built on February 13 2026 18.38.33 EST)"
      }
    }
  ]
}
    var bounds = L.latLngBounds(L.latLng(37.684834, 106.784616), L.latLng(37.821779, 106.868185));                        
    var googleStreet =  L.tileLayer('https://mt0.google.com/vt/lyrs=m&hl=en&x={x}&y={y}&z={z}', {maxZoom: 20, attribution: '&copy; Google Maps'})
    var googleHybrid =  L.tileLayer('https://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}', {maxZoom: 20, attribution: '&copy; Google Maps'})
    
    // When this map is embedded in the GEM Wiki via an iframe widget, the enclosing html css for width and height of #map does not consistently
    // come through, resulting in sometimes being 0, 0. This seems to mess fitBounds up resulting in a fully zoomed out map showing the entire planet.
    // I tried many different adjustments, but in the end chose a setView with a fixed zoom of 12 to be much more reliable.
    //var map = L.map('map', {layers: [googleHybrid]}).fitBounds(bounds) 
                        
    var map = L.map('map', {layers: [googleHybrid]}).setView([37.7533065, 106.8264005], 12.0)                     
    var markerLayerGroup = L.layerGroup();
                        

    function onEachFeature(feature, layer) {
        let popupContent = "<b><u>" + feature.properties['description'] + "</u></b><br /><br />"
        let tooltipContent = feature.properties['id'] + ": " + feature.properties['description']
        for (const [key, value] of Object.entries(feature.properties)) {
            popupContent += '<b>' + key + '</b>: ' + value + '<br />'
        }
        layer.bindPopup(popupContent, { maxHeight: 200 , maxWidth: 400})
        layer.bindTooltip(tooltipContent, { permanent: false, direction: 'right'});
        if (feature.properties['mine feature category'] == "mine boundary") {
           layer.setStyle({ color: '#CA4A50', fillColor: '#CA4A50', opacity: 1.0 });
        }
        markerLayerGroup.addLayer(layer)
	}
    
    markerLayerGroup.addTo(map);
    const mineLayer = L.geoJSON(mine, {onEachFeature}).addTo(map)
    var GEMMineIcon = L.icon({ iconUrl: 'https://maps.google.com/mapfiles/kml/paddle/red-circle.png', iconSize:  [40, 40]});
    
    const myDiv = document.getElementById('map');
    const width = myDiv.offsetWidth;
    const height = myDiv.offsetHeight;
    console.log("#map width: " + width + ", height: " + height);                    

    // Create a "dummy" layer group specifically to act as the tooltip toggle switch in the control
    var tooltipToggleLayer = L.layerGroup();
    // Add event listeners to the map that listen for the toggle layer being added or removed
    map.on('layeradd', function (e) {
        if (e.layer === tooltipToggleLayer) {
            // When the "Tooltip" overlay is selected, iterate over all markers and make tooltips permanent
            markerLayerGroup.eachLayer(function (layer) {
                if (layer.getTooltip()) {
                    layer.getTooltip().options.permanent = true;
                    layer.openTooltip(); // Open the tooltip permanently
                }
            });
        }
    });
    map.on('layerremove', function (e) {
        if (e.layer === tooltipToggleLayer) {
            // When the "Tooltip" overlay is deselected, make tooltips non-permanent and close them
            markerLayerGroup.eachLayer(function (layer) {
                if (layer.getTooltip()) {
                    layer.getTooltip().options.permanent = false;
                    layer.closeTooltip();
                }
            });
        }
    });

    map.on('zoomend', function() {
        console.log("Current zoom level: " + map.getZoom());
    });

    var baseMaps = {
        "Satellite view": googleHybrid,
        "Street view": googleStreet
    };
    var overlayMaps = {
        "Labels": tooltipToggleLayer // The toggle switch for tooltips
    };
    var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
                        
    var GEMMine;
                        
    GEMMine = L.marker([37.784465, 106.846093], {icon: GEMMineIcon}).addTo(map); 
    GEMMine.bindPopup("Operating status(es): Operating");
    GEMMine.bindTooltip("Shuangma No.1 Coal Mine", { permanent: true, direction: 'right'});
